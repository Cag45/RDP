
name: RDP
on:
  workflow_dispatch:
jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600
    steps:
    - name: Configure Core RDP Settings
      run: |
        # Enable Remote Desktop and disable Network Level Authentication (if needed)
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
          -Name "fDenyTSConnections" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
          -Name "UserAuthentication" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
          -Name "SecurityLayer" -Value 0 -Force
        # Remove any existing rule with the same name to avoid duplication
        netsh advfirewall firewall delete rule name="RDP-Tailscale"

        # For testing, allow any incoming connection on port 3389
        netsh advfirewall firewall add rule name="RDP-Tailscale" `
          dir=in action=allow protocol=TCP localport=3389
        # (Optional) Restart the Remote Desktop service to ensure changes take effect
        Restart-Service -Name TermService -Force

    - name: Create RDP User with Secure Password
      run: |
        # تأكد من أن هذا الجزء يتم نسخه ولصقه بشكل صحيح لتجنب أخطاء التحليل
        Add-Type -AssemblyName System.Security
        <LaTex>$charSet = @{
            Upper   = [char[]](65..90)
            Lower   = [char[]](97..122)
            Number  = [char[]](48..57)
            Special = ([char[]](33..47) + [char[]](58..64) + [char[]](91..96) + [char[]](123..126))
        }
        $</LaTex>rawPassword = @()
        <LaTex>$rawPassword += $</LaTex>charSet.Upper | Get-Random -Count 4
        <LaTex>$rawPassword += $</LaTex>charSet.Lower | Get-Random -Count 4
        <LaTex>$rawPassword += $</LaTex>charSet.Number | Get-Random -Count 4
        <LaTex>$rawPassword += $</LaTex>charSet.Special | Get-Random -Count 4
        <LaTex>$password = -join ($</LaTex>rawPassword | Sort-Object { Get-Random })
        <LaTex>$securePass = ConvertTo-SecureString $</LaTex>password -AsPlainText -Force
        New-LocalUser -Name "RDP" -Password <LaTex>$securePass -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member "RDP"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"

        echo "RDP_CREDS=User: RDP | Password: $</LaTex>password" >> <LaTex>$env:GITHUB_ENV

        if (-not (Get-LocalUser -Name "RDP")) {
            Write-Error "User creation failed"
            exit 1
        }

    - name: Install Tailscale
      run: |
        $</LaTex>tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
        <LaTex>$installerPath = "$</LaTex>env:TEMP\tailscale.msi"

        Invoke-WebRequest -Uri <LaTex>$tsUrl -OutFile $</LaTex>installerPath
        Start-Process msiexec.exe -ArgumentList "/i", "`"<LaTex>$installerPath`"", "/quiet", "/norestart" -Wait
        Remove-Item $</LaTex>installerPath -Force

    - name: Establish Tailscale Connection
      run: |
        # Bring up Tailscale with the provided auth key and set a unique hostname
        & "<LaTex>$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$</LaTex>{{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-<LaTex>$env:GITHUB_RUN_ID

        # Wait for Tailscale to assign an IP
        $</LaTex>tsIP = <LaTex>$null
        $</LaTex>retries = 0
        while (-not <LaTex>$tsIP -and $</LaTex>retries -lt 10) {
            <LaTex>$tsIP = & "$</LaTex>env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            Start-Sleep -Seconds 5
            <LaTex>$retries++
        }

        if (-not $</LaTex>tsIP) {
            Write-Error "Tailscale IP not assigned. Exiting."
            exit 1
        }
        echo "TAILSCALE_IP=<LaTex>$tsIP" >> $</LaTex>env:GITHUB_ENV

    - name: Verify RDP Accessibility
      run: |
        Write-Host "Tailscale IP: <LaTex>$env:TAILSCALE_IP"

        # Test connectivity using Test-NetConnection against the Tailscale IP on port 3389
        $</LaTex>testResult = Test-NetConnection -ComputerName <LaTex>$env:TAILSCALE_IP -Port 3389
        if (-not $</LaTex>testResult.TcpTestSucceeded) {
            Write-Error "TCP connection to RDP port 3389 failed"
            exit 1
        }
        Write-Host "TCP connectivity successful!"

    - name: Maintain Connection
      run: |
        Write-Host "`n=== RDP ACCESS ==="
        Write-Host "Address: <LaTex>$env:TAILSCALE_IP"
        Write-Host "Username: RDP"
        Write-Host "Password: $</LaTex>(echo <LaTex>$env:RDP_CREDS)"
        Write-Host "==================`n"

        # Keep runner active indefinitely (or until manually cancelled)
        while ($</LaTex>true) {
            Write-Host "[$(Get-Date)] RDP Active - Use Ctrl+C in workflow to terminate"
            Start-Sleep -Seconds 300
        }
